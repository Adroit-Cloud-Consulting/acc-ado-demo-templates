# Adroit Cloud Consulting
# File: template-create-pipeline.yml

parameters:
  subscription: ''
  repo_name: ''
  ado_org: ''
  project: ''


steps:
# Create Azure Pipeline
- task: AzureCLI@2
  displayName: "Create Pipeline"
  inputs:
    azureSubscription: $(subscription)
    scriptType: 'pscore'
    scriptLocation: inlineScript
    inlineScript: |
        # Create Pipeline
        $pipelineCheck = az pipelines list --org $(ado_org) --project $(ado_project) --query "[?name=='$(repo_name)-pipeline']" -o json | ConvertFrom-Json

        if (!($pipelineCheck)) {
            Write-Host "##[warning]Pipeline: $(repo_name)-pipeline doesnt exist creating..."
            az pipelines create --name "$(repo_name)-pipeline" --org $(ado_org) --project $(ado_project) --yml-path azure-pipeline.yml `
            --repository $(repo_name) --repository-type tfsgit --branch master --skip-first-run
        }
        else {
            Write-Host "##[section]Pipeline: $(repo_name)-pipline already exists!"
        }
  env:
    AZURE_DEVOPS_EXT_PAT: $(pat_token)